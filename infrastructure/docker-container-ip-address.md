# 도커 컨테이너 IP 주소 트러블 슈팅

## Summary
babble 프로젝트를 진행하면서, 상용 서버에서 릴리즈 테스트를 진행하지 말고 
별도의 테스팅 서버를 만들어서 릴리즈 테스트를 진행하고자 했다.

상용 서버와 온전히 같은 환경을 갖추기 위해 EC2 인스턴스를 추가로 3~4개 개설하면서 
테스팅 서버를 개설할까 고민해봤지만, 도커를 사용해서 각 계층을 독립시키면 
EC2 인스턴스 1개만으로도 충분히 테스트가 가능할 것 같았다. (추후 인스턴스를 제거하기도 편하고)

![image](https://user-images.githubusercontent.com/37354145/126854249-a664eed8-3eb2-42a5-a551-0d0149449637.png)

결국 위 그림과 같은 형태로 도커 위에 3개의 컨테이너를 올렸다. 
web-server는 nginx로 구성하여 외부(public IP)로 부터 전달되는 요청을 
바로 옆 WAS 컨테이너로 전달한다. 요청을 전달 받은 WAS는 로직을 수행하고, 
영속성이 부여된 데이터가 필요하다면 바로 옆 Database 컨테이너를 찌른다.

이 때 컨테이너끼리 통신 시킬 방법이 필요했는데, 상용 서버와 최대한 비슷한 환경 구성을 위해 
도커에서 제공하는 방법을 사용하지 않고 IP로만 요청을 주고 받아야 했다. 
그러기 위해서 1차적으로 알아야 할 것은 도커 컨테이너의 IP 주소다.

```
$ sudo docker inspect [컨테이너 ID] | grep IPAddress
```
```
"SecondaryIPAddresses": null,
"IPAddress": "172.17.0.4",
    "IPAddress": "172.17.0.4",
```

inspect 명령을 통해 컨테이너 내부에서 사용되는 IP 주소를 알아낼 수 있다.

> 도커 컨테이너의 기본 IP 주소 범위는 `172.17.0.*` 이다. 
> 결국 가장 마지막 번호를 알아내기 위함이다.

이렇게 알아낸 IP주소로 `Web-server - WAS - DB` 컨테이너를 서로 연결했고, 성공적으로 테스트가 가능했다.

<br>

## 원인 파악
그러나 며칠 후 CI/CD를 통해 WAS가 재배포 되면서 문제가 발생했다. 
WAS가 빌드 된 후 컨테이너로 도커에 오르자마자 종료되는 것이었다. 처음에는 단순히 WAS 빌드가 잘못 되었다고 판단했으나, WAS를 로컬에 띄워보니 아무런 문제가 없었다.

결국 한참을 헤매고 나서야 원인을 찾을 수 있었는데, 바로 데이터베이스의 유저계정을 생성할 때 할당했던 IP주소가 문제였다.

```sql
CREATE USER [유저 이름]@'[IP주소]' IDENTIFIED BY '[비밀번호]';
```

데이터베이스를 구축할 때 보안을 위해 `[IP주소]`에 정확하게 WAS 컨테이너의 IP주소를 기입했는데, WAS가 재빌드 된 후 기존 컨테이너를 버리고 새로운 컨테이너에 다시 올라오면서 IP주소가 변경된 것이다.

![image](https://user-images.githubusercontent.com/37354145/126854744-bc7e1ec0-ea57-4242-a4ba-dfd1df81587a.png)

그러거나 말거나 데이터베이스는 기존 IP주소만 허용하고 있으니, WAS가 실행되는 단계에서 에러를 
발생시키고, 컨테이너가 바로 다운 되었던 것이다.

<br>

## 해결 방법
현재는 데이터베이스에서 모든 IP 주소에서 들어오는 요청을 허용하는 것으로 해결하였으나, 
도커 컨테이너를 올릴 때 원하는 IP를 직접 기입하는 방법으로도 해결 할 수 있다.

```
# docker run 명령에 함께할 수 있는 옵션들

--add-host : 컨테이너 내부의 /etc/hosts에 호스트 이름과 IP 주소를 설정해준다. (없으면 임의의 ip adress 할당)

--dns : DNS 서버의 IP 주소를 설정해준다.

--expose : 포트 번호 할당

--mac-address : 컨테이너 MAC 주소 설정

--net : 컨테이너 네트워크 설정 (bridge, none, container:<name or d> , host)

-h, --hostname : 컨테이너 호스트 이름 설정

-P, --publish-all : 임의의 포트를 컨테이너에 할당

-p [호스트포트]:[컨테이너포트] : 호스트와 컨테이너 포트를 매핑시켜준다.

--link : 다른 컨테이너에서 접근시 이름을 설정
```

<br>

## References
- [docker run 과 docker 네트워크 설정, 컨테이너 라이프사이클](https://www.leafcats.com/191)